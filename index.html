<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人記帳平台 (AI分析版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* 其他樣式 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease, opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-4xl mx-auto p-4 md:p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">個人記帳平台</h1>
            <p class="text-gray-500 mt-1">精準掌握您的固定與日常收支</p>
        </header>

        <!-- 載入中提示 -->
        <div id="loading-state" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">正在與雲端同步資料...</p>
        </div>

        <!-- 主內容容器 -->
        <div id="app-container" class="hidden">
            <!-- 分頁導覽 -->
            <nav class="flex space-x-2 bg-white p-2 rounded-xl shadow-md mb-6">
                <button data-page="page-dashboard" class="nav-btn flex-1 py-2 px-4 text-center rounded-lg font-semibold transition">主控台</button>
                <button data-page="page-fixed-income-history" class="nav-btn flex-1 py-2 px-4 text-center rounded-lg font-semibold transition">固定收入紀錄</button>
                <button data-page="page-fixed-expense-history" class="nav-btn flex-1 py-2 px-4 text-center rounded-lg font-semibold transition">固定支出紀錄</button>
                <button data-page="page-daily-history" class="nav-btn flex-1 py-2 px-4 text-center rounded-lg font-semibold transition">日常收支紀錄</button>
            </nav>

            <!-- 主控台頁面 -->
            <main id="page-dashboard" class="page">
                <section id="summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 sticky top-4 z-10">
                    <div class="bg-white/80 backdrop-blur-sm border border-gray-200 text-green-800 p-4 rounded-xl shadow-md text-center">
                        <h2 class="text-sm font-medium">總收入</h2>
                        <p id="total-income" class="text-2xl font-semibold mt-1">$0</p>
                    </div>
                    <div class="bg-white/80 backdrop-blur-sm border border-gray-200 text-red-800 p-4 rounded-xl shadow-md text-center">
                        <h2 class="text-sm font-medium">總支出</h2>
                        <p id="total-expense" class="text-2xl font-semibold mt-1">$0</p>
                    </div>
                    <div class="bg-white/80 backdrop-blur-sm border border-gray-200 text-blue-800 p-4 rounded-xl shadow-md text-center">
                        <h2 class="text-sm font-medium">目前餘額</h2>
                        <p id="balance" class="text-2xl font-semibold mt-1">$0</p>
                    </div>
                </section>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h2 class="text-xl font-semibold mb-3 text-gray-700">1. 新增固定收入</h2>
                            <form id="fixed-income-form" class="grid grid-cols-3 gap-3 items-end">
                                <div class="col-span-2">
                                    <label for="fixed-income-desc" class="text-sm font-medium text-gray-600">項目</label>
                                    <input type="text" id="fixed-income-desc" placeholder="例如：公司薪轉" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="fixed-income-amount" class="text-sm font-medium text-gray-600">金額</label>
                                    <input type="number" id="fixed-income-amount" placeholder="0" required min="0" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                </div>
                                <button type="submit" class="col-span-3 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">新增收入</button>
                            </form>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h2 class="text-xl font-semibold mb-3 text-gray-700">2. 新增固定支出</h2>
                            <form id="fixed-expense-form" class="grid grid-cols-3 gap-3 items-end">
                                <div class="col-span-2">
                                    <label for="fixed-expense-desc" class="text-sm font-medium text-gray-600">項目</label>
                                    <input type="text" id="fixed-expense-desc" placeholder="例如：房屋貸款" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                </div>
                                <div>
                                    <label for="fixed-expense-amount" class="text-sm font-medium text-gray-600">金額</label>
                                    <input type="number" id="fixed-expense-amount" placeholder="0" required min="0" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                </div>
                                <button type="submit" class="col-span-3 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">新增支出</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-3">
                             <h2 class="text-xl font-semibold text-gray-700">3. 新增日常收支</h2>
                             <button id="ai-analysis-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                 ✨ 取得 AI 財務分析
                             </button>
                        </div>
                         <form id="daily-transaction-form" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                            <div class="md:col-span-2">
                                <label for="daily-desc" class="text-sm font-medium text-gray-600">項目說明</label>
                                <input type="text" id="daily-desc" placeholder="例如：晚餐、交通" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label for="daily-amount" class="text-sm font-medium text-gray-600">金額</label>
                                <input type="number" id="daily-amount" placeholder="0" required min="0" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                 <label for="daily-type" class="text-sm font-medium text-gray-600">類型</label>
                                <select id="daily-type" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white">
                                    <option value="expense">支出</option>
                                    <option value="income">收入</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">新增</button>
                        </form>
                    </div>
                </div>
                
                <section class="mt-6 bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">每月收支趨勢圖 (近6個月)</h2>
                    <div id="chart-container" class="relative h-64 md:h-80">
                        <canvas id="trend-chart"></canvas>
                        <p id="chart-empty-state" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">暫無足夠資料可繪製圖表</p>
                    </div>
                </section>
            </main>
            
            <!-- 固定收入歷史紀錄頁面 -->
            <section id="page-fixed-income-history" class="page bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">固定收入歷史紀錄</h2>
                <div id="fixed-income-history-list" class="space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2"></div>
            </section>
            
            <!-- 固定支出歷史紀錄頁面 -->
            <section id="page-fixed-expense-history" class="page bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">固定支出歷史紀錄</h2>
                <div id="fixed-expense-history-list" class="space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2"></div>
            </section>

            <!-- 日常收支歷史紀錄頁面 -->
            <section id="page-daily-history" class="page bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">日常收支歷史紀錄</h2>
                <div id="daily-history-list" class="space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2"></div>
            </section>

        </div>
    </div>

    <!-- AI 分析 Modal -->
    <div id="ai-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="ai-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 opacity-0"></div>
        <div id="ai-modal-container" class="modal-container bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto z-10 transform scale-95 opacity-0">
            <div class="p-6">
                <div class="flex justify-between items-start">
                    <h3 class="text-2xl font-bold text-gray-800">✨ AI 智慧財務分析</h3>
                    <button id="ai-modal-close-btn" class="text-gray-400 hover:text-gray-600 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="ai-modal-content" class="mt-4 prose max-w-none prose-indigo">
                    <!-- Loading state -->
                    <div id="ai-modal-loading" class="flex flex-col items-center justify-center py-10">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-500"></div>
                        <p class="mt-4 text-gray-600">您的專屬財務助理正在分析中，請稍候...</p>
                    </div>
                    <!-- Result -->
                    <div id="ai-modal-result" class="hidden text-gray-700 leading-relaxed"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM 元素 ---
        const loadingState = document.getElementById('loading-state');
        const appContainer = document.getElementById('app-container');
        const pages = document.querySelectorAll('.page');
        const navBtns = document.querySelectorAll('.nav-btn');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const balanceEl = document.getElementById('balance');
        const fixedIncomeForm = document.getElementById('fixed-income-form');
        const fixedExpenseForm = document.getElementById('fixed-expense-form');
        const dailyTransactionForm = document.getElementById('daily-transaction-form');
        const fixedIncomeHistoryList = document.getElementById('fixed-income-history-list');
        const fixedExpenseHistoryList = document.getElementById('fixed-expense-history-list');
        const dailyHistoryList = document.getElementById('daily-history-list');
        const aiAnalysisBtn = document.getElementById('ai-analysis-btn');
        const chartEmptyState = document.getElementById('chart-empty-state');
        const aiModal = document.getElementById('ai-modal');
        const aiModalOverlay = document.getElementById('ai-modal-overlay');
        const aiModalContainer = document.getElementById('ai-modal-container');
        const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
        const aiModalLoading = document.getElementById('ai-modal-loading');
        const aiModalResult = document.getElementById('ai-modal-result');

        // --- Firebase 設定 ---
        // 請將此處替換為您自己 Firebase 專案的設定
        const firebaseConfig = {
            apiKey: "AIzaSyBB0kcD1ECH7CLXvM01RliMpzTLqBy3tgk",
            authDomain: "my-accounting-app-data-f7f1e.firebaseapp.com",
            projectId: "my-accounting-app-data-f7f1e",
            storageBucket: "my-accounting-app-data-f7f1e.appspot.com", // 已為您修正為標準格式
            messagingSenderId: "923572739465",
            appId: "1:923572739465:web:c785288d08cbdc0ab75558",
            measurementId: "G-CWPD2LNQSC"
        };
        
        let db, auth, userId, transactionsCollectionRef, unsubscribe;
        let currentDailyTransactions = [];
        let trendChart;

        // --- 頁面切換邏輯 ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            navBtns.forEach(btn => {
                if (btn.dataset.page === pageId) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-200');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-200');
                }
            });
        }
        
        // --- 主要應用程式邏輯 ---
        async function main() {
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) { 
                    showError("Firebase 設定無效。請檢查 firebaseConfig 物件。"); 
                    return; 
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        // 簡化後的資料庫路徑，更適合獨立專案
                        const collectionPath = `users/${userId}/transactions`;
                        transactionsCollectionRef = collection(db, collectionPath);
                        attachSnapshotListener();
                        loadingState.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        showPage('page-dashboard'); // 預設顯示主控台
                    }
                });
                
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                showError("無法連接到雲端服務。");
            }
        }
        
        function attachSnapshotListener() {
            if (unsubscribe) unsubscribe();
            const q = query(transactionsCollectionRef, orderBy("createdAt", "desc"));
            unsubscribe = onSnapshot(q, snapshot => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI(transactions);
            }, error => {
                console.error("讀取資料失敗:", error);
                showError("無法讀取您的記帳資料。");
            });
        }

        function renderUI(transactions) {
            const fixedIncomes = transactions.filter(t => t.category === 'fixedIncome');
            const fixedExpenses = transactions.filter(t => t.category === 'fixedExpense');
            currentDailyTransactions = transactions.filter(t => t.category === 'daily' || !t.category);
            
            renderHistoryList(fixedIncomeHistoryList, fixedIncomes);
            renderHistoryList(fixedExpenseHistoryList, fixedExpenses);
            renderHistoryList(dailyHistoryList, currentDailyTransactions);
            
            aiAnalysisBtn.disabled = currentDailyTransactions.filter(t => t.type === 'expense').length === 0;

            updateSummary(transactions);
            renderTrendChart(transactions);
        }
        
        function renderHistoryList(listElement, items) {
            listElement.innerHTML = '';
            if (items.length === 0) {
                 listElement.innerHTML = `<p class="text-center text-gray-500 py-10">尚無任何歷史紀錄。</p>`;
            } else {
                items.forEach(item => addHistoryItemToDOM(listElement, item));
            }
        }

        function updateSummary(transactions) {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            totalIncomeEl.textContent = `$${income.toLocaleString()}`;
            totalExpenseEl.textContent = `$${expense.toLocaleString()}`;
            balanceEl.textContent = `$${balance.toLocaleString()}`;
            balanceEl.classList.toggle('text-red-600', balance < 0);
            balanceEl.classList.toggle('text-blue-800', balance >= 0);
        }

        function addHistoryItemToDOM(parentElement, transaction) {
            const item = document.createElement('div');
            const isIncome = transaction.type === 'income';
            const date = transaction.createdAt?.toDate()?.toLocaleDateString() || '日期不明';
            
            item.className = 'flex justify-between items-center p-3 rounded-lg bg-gray-50 border border-gray-200';
            item.innerHTML = `
                <div class="flex-1 overflow-hidden">
                    <p class="font-medium text-gray-800 truncate">${transaction.description}</p>
                    <p class="text-sm text-gray-500">${date}</p>
                </div>
                <div class="flex items-center ml-4">
                    <p class="font-semibold text-md ${isIncome ? 'text-green-600' : 'text-red-600'}">
                        ${isIncome ? '+' : '-'}$${transaction.amount.toLocaleString()}
                    </p>
                    <button data-id="${transaction.id}" class="delete-btn ml-4 text-gray-400 hover:text-red-500 transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `;
            parentElement.appendChild(item);
        }

        function renderTrendChart(transactions) {
            if (trendChart) {
                trendChart.destroy();
            }

            if (transactions.length === 0) {
                chartEmptyState.classList.remove('hidden');
                return;
            } else {
                chartEmptyState.classList.add('hidden');
            }

            const monthlyData = {};
            const labels = [];
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const label = `${year}-${month}`;
                labels.push(label);
                monthlyData[label] = { income: 0, expense: 0 };
            }

            transactions.forEach(t => {
                if (t.createdAt && t.createdAt.toDate) {
                    const date = t.createdAt.toDate();
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const key = `${year}-${month}`;

                    if (monthlyData[key]) {
                        if (t.type === 'income') {
                            monthlyData[key].income += t.amount;
                        } else {
                            monthlyData[key].expense += t.amount;
                        }
                    }
                }
            });

            const incomeData = labels.map(label => monthlyData[label].income);
            const expenseData = labels.map(label => monthlyData[label].expense);
            
            const ctx = document.getElementById('trend-chart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '收入',
                            data: incomeData,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3,
                        },
                        {
                            label: '支出',
                            data: expenseData,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- Gemini API 相關功能 ---
        function openAiModal() {
            aiModal.classList.remove('hidden');
            aiModalLoading.classList.remove('hidden');
            aiModalResult.classList.add('hidden');
            aiModalResult.innerHTML = '';
            setTimeout(() => {
                aiModalOverlay.classList.remove('opacity-0');
                aiModalContainer.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeAiModal() {
            aiModalOverlay.classList.add('opacity-0');
            aiModalContainer.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                aiModal.classList.add('hidden');
            }, 300);
        }

        function formatResponseForHTML(text) {
             return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/\*(.*?)\*/g, '<em>$1</em>')       
                .replace(/(\n)/g, '<br>');
        }

        async function getFinancialAnalysis() {
            openAiModal();
            const dailyExpenses = currentDailyTransactions.filter(t => t.type === 'expense');
            if (dailyExpenses.length === 0) {
                 aiModalResult.innerHTML = '<p>目前沒有日常支出紀錄可供分析喔！</p>';
                 aiModalLoading.classList.add('hidden');
                 aiModalResult.classList.remove('hidden');
                 return;
            }

            const expenseList = dailyExpenses.map(e => `- ${e.description}: $${e.amount}`).join('\n');
            
            const systemPrompt = `您是一位友善且樂於助人的個人理財助理。您的任務是分析使用者提供的日常支出清單，並以繁體中文提供簡短、鼓勵性且可行的財務建議。請遵循以下格式：
1.  用一個溫暖的問候開始。
2.  簡要總結整體的消費狀況。
3.  找出 2-3 個最主要的支出類別。
4.  針對這些主要類別，提供 1-2 個具體、簡單且容易執行的省錢訣竅。
5.  最後用一句鼓勵的話結尾。
請保持語氣正面、友善，避免使用困難的金融術語。`;

            const userQuery = `這是我最近的日常支出清單，請幫我分析一下：\n${expenseList}`;

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API 請求失敗，狀態碼：${response.status}`);
                }

                const result = await response.json();
                const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (analysisText) {
                    aiModalResult.innerHTML = formatResponseForHTML(analysisText);
                } else {
                    aiModalResult.innerHTML = '<p>抱歉，AI 分析時發生錯誤，請稍後再試。</p>';
                }

            } catch (error) {
                console.error("Gemini API 呼叫失敗:", error);
                aiModalResult.innerHTML = `<p>無法連接到 AI 分析服務。請檢查您的網路連線或稍後再試。</p><p class="text-xs text-gray-400 mt-2">錯誤訊息: ${error.message}</p>`;
            } finally {
                aiModalLoading.classList.add('hidden');
                aiModalResult.classList.remove('hidden');
            }
        }

        // --- 事件處理函式 ---
        async function handleAddTransaction(e, category, type) {
            e.preventDefault();
            const form = e.target;
            const description = form.querySelector('input[type="text"]').value.trim();
            const amount = +form.querySelector('input[type="number"]').value;
            const transactionType = type || form.querySelector('select')?.value;

            if (!description || !amount || amount <= 0) {
                alert("請輸入有效的項目與金額！");
                return;
            }

            try {
                await addDoc(transactionsCollectionRef, {
                    description, amount, category, type: transactionType, createdAt: serverTimestamp()
                });
                form.reset();
                showPage('page-dashboard');
            } catch (error) {
                console.error("新增資料失敗: ", error);
                showError("無法新增紀錄。");
            }
        }
        
        async function handleDeleteTransaction(e) {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const id = deleteBtn.getAttribute('data-id');
                if (id) {
                    try {
                        await deleteDoc(doc(db, transactionsCollectionRef.path, id));
                    } catch (error) {
                        console.error("刪除資料失敗: ", error);
                        showError("無法刪除紀錄。");
                    }
                }
            }
        }
        
        function showError(message) {
            loadingState.classList.remove('hidden');
            appContainer.classList.add('hidden');
            loadingState.innerHTML = `<div class="text-center py-8 bg-red-100 text-red-700 rounded-lg p-4">${message}</div>`;
        }
        
        // --- 綁定事件監聽 ---
        navBtns.forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.page)));
        fixedIncomeForm.addEventListener('submit', (e) => handleAddTransaction(e, 'fixedIncome', 'income'));
        fixedExpenseForm.addEventListener('submit', (e) => handleAddTransaction(e, 'fixedExpense', 'expense'));
        dailyTransactionForm.addEventListener('submit', (e) => handleAddTransaction(e, 'daily'));
        appContainer.addEventListener('click', handleDeleteTransaction);
        aiAnalysisBtn.addEventListener('click', getFinancialAnalysis);
        aiModalCloseBtn.addEventListener('click', closeAiModal);
        aiModalOverlay.addEventListener('click', closeAiModal);

        // --- 啟動應用程式 ---
        main();
    </script>
</body>
</html>

